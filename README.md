# IDENT to AmoCRM Integration

Модуль интеграции между системой управления стоматологической клиникой IDENT и CRM-системой AmoCRM.

## Возможности

- **Полная синхронизация**: Первоначальная загрузка всех пациентов из IDENT в AmoCRM
- **Инкрементальная синхронизация**: Обновление только измененных записей каждые 2 минуты
- **Глубокая синхронизация**: Полная проверка и обновление данных дважды в день
- **Обработка дубликатов**: Интеллектуальная логика поиска по ID пациента и номеру телефона
- **OAuth 2.0 авторизация**: Безопасная интеграция с AmoCRM API
- **Docker-контейнеризация**: Простое развертывание и масштабирование

## Требования

- Python 3.11+
- Docker и Docker Compose
- Доступ к базе данных IDENT (SQL Server)
- Аккаунт AmoCRM с настроенной интеграцией

## Установка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd ident_amocrm_integration
```

### 2. Настройка окружения

Скопируйте файл `.env.example` в `.env` и заполните необходимые параметры:

```bash
cp .env.example .env
```

Основные параметры:
- `DB_*` - подключение к базе данных IDENT
- `AMOCRM_*` - данные для интеграции с AmoCRM
- `SYNC_*` - параметры синхронизации

### 3. Настройка AmoCRM

1. Войдите в ваш аккаунт AmoCRM
2. Перейдите в Настройки → Интеграции → Создать интеграцию
3. Укажите:
   - Название интеграции
   - Redirect URI: `http://localhost:8080/callback`
4. Сохраните Client ID и Client Secret в `.env`

### 4. Создание кастомных полей в AmoCRM

Создайте следующие кастомные поля для контактов в AmoCRM:

| Поле | ID | Тип | Описание |
|------|----|----|----------|
| Телефон | 2 | Телефон | Основной номер телефона |
| Возраст | 3 | Число | Возраст пациента |
| Пол | 4 | Список | Мужской/Женский/Не указан |
| Приемы | 5 | Текст | История приемов |
| Всего визитов | 6 | Число | Количество визитов |
| Номер карты | 7 | Текст | Номер медицинской карты |
| Дата рождения | 8 | Дата | Дата рождения |
| Комментарий | 9 | Текст | Примечания |
| Скидка | 10 | Число | Процент скидки |
| Отказ от SMS | 11 | Чекбокс | Отказ от SMS-рассылок |
| Причина архивации | 12 | Текст | Причина архивации |
| Статус | 13 | Список | Активный/Архивный |
| СНИЛС | 14 | Текст | СНИЛС пациента |
| ИНН | 15 | Текст | ИНН пациента |
| Филиал | 16 | Текст | Филиал клиники |
| Номер пациента | 17 | Текст | Внутренний номер |
| Аванс | 18 | Число | Сумма аванса |
| Долг | 19 | Число | Сумма долга |
| ID пациента IDENT | 25 | Текст | Уникальный ID из IDENT |

## Запуск

### Авторизация в AmoCRM (первый запуск)

```bash
# Запустить сервер авторизации
docker-compose --profile auth up auth

# Перейдите по ссылке из логов и авторизуйтесь в AmoCRM
# После успешной авторизации можно остановить сервер (Ctrl+C)
```

### Запуск синхронизации

```bash
# Запуск всех сервисов
docker-compose up -d

# Просмотр логов
docker-compose logs -f sync

# Остановка
docker-compose down
```

### Тестирование

```bash
# Тест синхронизации одного пациента
docker-compose run --rm sync python main.py test --patient-id 123
```

## Логика синхронизации

### Первичный ключ
- **ID пациента IDENT** (поле 25) - основной идентификатор

### Вторичный ключ
- **Номер телефона** (поле 2) - используется если пациент не найден по ID

### Алгоритм обработки записи
1. Поиск контакта в AmoCRM по ID пациента IDENT
2. Если не найден - поиск по номеру телефона
3. Если найден - обновление существующего контакта
4. Если не найден - создание нового контакта

### Расписание синхронизации
- **Инкрементальная**: каждые 2 минуты (изменённые записи)
- **Глубокая**: 08:00 и 20:00 (полная проверка)

## Мониторинг

Логи сохраняются в директории `logs/`:
- `sync.log` - основной лог синхронизации
- Ротация при достижении 10MB
- Хранение 30 дней

## Структура проекта

```
.
├── src/
│   ├── models.py       # Модели данных
│   ├── database.py     # Работа с БД IDENT
│   ├── amocrm.py      # API клиент AmoCRM
│   └── sync.py        # Логика синхронизации
├── config.py          # Конфигурация
├── main.py           # Точка входа
├── requirements.txt  # Python зависимости
├── Dockerfile       # Docker образ
├── docker-compose.yml # Docker Compose конфигурация
└── README.md        # Документация
```

## Безопасность

- OAuth токены хранятся в Redis с автоматическим обновлением
- Все настройки хранятся в переменных окружения
- База данных монтируется только для чтения
- Приложение работает от непривилегированного пользователя

## Troubleshooting

### Ошибка подключения к БД
- Проверьте параметры подключения в `.env`
- Убедитесь, что SQL Server доступен из Docker контейнера
- Проверьте правильность ODBC драйвера

### Ошибка авторизации AmoCRM
- Проверьте Client ID и Client Secret
- Убедитесь, что Redirect URI совпадает с настройками в AmoCRM
- Попробуйте переавторизоваться

### Дубликаты контактов
- Проверьте настройку кастомных полей в AmoCRM
- Убедитесь, что поле ID пациента (25) уникально

## Поддержка

При возникновении проблем создайте issue в репозитории с описанием:
- Версия системы
- Текст ошибки из логов
- Шаги для воспроизведения
